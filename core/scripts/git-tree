#!/usr/bin/env bash
# -----------------------------------------------------------------------------
# git-tree
#
# Description:
#   Displays a tree of files under a given target folder in a Git repository,
#   respecting .gitignore. Uses `git ls-files` to determine visible files and
#   `tree --fromfile` to render the directory tree (with fallback if tree
#   is not installed).
#
# Usage:
#   ./git-tree [target-folder]
#
# Examples:
#   ./git-tree
#   ./git-tree deployments/impact-simulation
#
# Requirements:
#   - Must be run inside a Git repository
#   - `tree` command optional (fallback provided)
# -----------------------------------------------------------------------------

set -euo pipefail

TARGET="${1:-.}"

git -c core.quotepath=false rev-parse --is-inside-work-tree >/dev/null 2>&1 || {
  echo "Error: not inside a git repository." >&2
  exit 1
}

ROOT="$(git rev-parse --show-toplevel)"
cd "$ROOT"

# Fallback tree renderer when tree command not available
render_tree_fallback() {
  awk -F/ '
  {
    depth = NF - 1
    for (i = 1; i < NF; i++) {
      prefix = ""
      for (j = 1; j < i; j++) prefix = prefix "│   "
      dir = $i
      key = ""
      for (k = 1; k <= i; k++) key = key "/" $k
      if (!(key in seen)) {
        seen[key] = 1
        print prefix "├── " dir
      }
    }
    prefix = ""
    for (j = 1; j < NF; j++) prefix = prefix "│   "
    print prefix "├── " $NF
  }
  ' | sed 's/│   ├── /├── /; s/│   │/│   │/g'
}

FILES=$(git -c core.quotepath=false ls-files --cached --others --exclude-standard -- "$TARGET")

if command -v tree &>/dev/null; then
  echo "$FILES" | tree --fromfile
else
  echo "."
  echo "$FILES" | sort | render_tree_fallback
fi

