#!/usr/bin/env bash
# -----------------------------------------------------------------------------
# dump-files
#
# Description:
#   Dumps the contents of all files under a given target folder in a Git
#   repository, respecting .gitignore. Each file is preceded by a formatted
#   header showing its path, followed by a separator.
#
# Usage:
#   dump-files <target-folder>
#
# Examples:
#   dump-files src/
#   dump-files deployments/impact-simulation
#
# Requirements:
#   - Must be run inside a Git repository
#   - Uses `git ls-files` to respect .gitignore
# -----------------------------------------------------------------------------

# --- Unicode/UTF-8 safety ---
#export LC_ALL="${LC_ALL:-en_US.UTF-8}"
#export LANG="${LANG:-en_US.UTF-8}"

set -euo pipefail

TARGET="${1:-}"

if [[ -z "$TARGET" ]]; then
  echo "Usage: $0 <target-folder>"
  exit 1
fi

# Resolve absolute path and change to target directory first
# This ensures we find the correct git repo for the target path
if [[ -d "$TARGET" ]]; then
  TARGET_DIR="$(cd "$TARGET" && pwd)"
  TARGET_REL="."
elif [[ -f "$TARGET" ]]; then
  TARGET_DIR="$(cd "$(dirname "$TARGET")" && pwd)"
  TARGET_REL="$(basename "$TARGET")"
else
  # Path doesn't exist - error
  echo "Error: target does not exist: $TARGET" >&2
  exit 1
fi

cd "$TARGET_DIR"

git rev-parse --is-inside-work-tree >/dev/null 2>&1 || {
  echo "Error: not inside a git repository." >&2
  exit 1
}

ROOT="$(git -c core.quotepath=false rev-parse --show-toplevel)"

# Calculate relative path from git root to target
TARGET_FROM_ROOT="${TARGET_DIR#$ROOT/}"
if [[ "$TARGET_FROM_ROOT" == "$TARGET_DIR" ]]; then
  # Target dir IS the root
  TARGET_FROM_ROOT="."
fi
if [[ "$TARGET_REL" != "." ]]; then
  if [[ "$TARGET_FROM_ROOT" == "." ]]; then
    TARGET_FROM_ROOT="$TARGET_REL"
  else
    TARGET_FROM_ROOT="$TARGET_FROM_ROOT/$TARGET_REL"
  fi
fi

cd "$ROOT"

# List tracked + untracked but not ignored files, then dump with headers
git -c core.quotepath=false ls-files --cached --others --exclude-standard "$TARGET_FROM_ROOT" \
  | while read -r f; do
      echo -e "\n# $f\n---"
      cat "$f"
      echo -e "\n* * *"
    done

