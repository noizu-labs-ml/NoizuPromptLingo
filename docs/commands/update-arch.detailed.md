# update-arch Command Reference

Refresh and expand architecture documentation, transforming stubs into detailed analysis and detecting drift between docs and codebase.

## Purpose

The `update-arch` command maintains `docs/PROJECT-ARCH.md` and its sub-files by:

1. Expanding stub files created by `/init-project-fast` into full documentation
2. Detecting drift between documentation and current codebase state
3. Preserving manual edits and architectural decisions added by humans
4. Updating stale sections while keeping relevant content intact

**Inputs:** Existing `docs/PROJECT-ARCH.md` and stub files
**Outputs:** Updated `docs/PROJECT-ARCH.md` and expanded `docs/PROJECT-ARCH/*.md` sub-files

---

## Design Philosophy

| Principle | Description |
|:----------|:------------|
| `incremental` | Only regenerate sections that are stale or incomplete |
| `expand-stubs` | Transform stub files from `/init-project-fast` into full documentation |
| `drift-detection` | Identify discrepancies between documentation and current codebase |
| `preserve-intent` | Maintain architectural decisions and rationale added by humans |

---

## Architecture Update Workflow

### Phase 1: Analyze Current State

The command first inventories existing documentation:

```text
inventory = {
    main_file: docs/PROJECT-ARCH.md
    sub_files: docs/PROJECT-ARCH/*.md
    stubs: files containing "Stub generated by init-project"
    detailed: fully expanded files
    missing: expected files not present
}
```

**Expected sub-files:**
- `layers.md`
- `domain.md`
- `patterns.md`
- `infrastructure.md`

**Update Mode Selection:**

| Condition | Mode | Action |
|:----------|:-----|:-------|
| No PROJECT-ARCH.md exists | `full-init` | Run `/init-project` instead |
| Stubs exist | `expand` | Expand stubs to detailed files |
| All detailed, possible drift | `refresh` | Validate and update stale sections |
| User requests specific section | `targeted` | Update only requested sections |

### Phase 2: Drift Detection

Compares documentation claims against codebase reality using validation scouts:

**Layer Validation:**
- Verify each claimed layer directory exists
- Check component claims match actual files
- Flag missing or renamed components

**Service Validation:**
- Verify config files exist at stated paths
- Check schema files match claimed locations
- Identify new services not documented

**Pattern Validation:**
- Verify pattern implementations still exist
- Check for new patterns not documented
- Flag deprecated patterns still listed

**Technology Stack Validation:**
- Compare claimed stack against manifest files
- Check version claims against `package.json`/`pyproject.toml`
- Identify new dependencies not documented

**Drift Report Format:**

```markdown
## Summary
**drift_detected**: yes|no
**severity**: none|minor|moderate|major
**sections_affected**: [section-list]

## Layer Drift
| Claimed | Status | Issue |
|:--------|:-------|:------|
| <layer> | valid|missing|renamed|changed | <description> |

## Service Drift
| Service | Status | Issue |
|:--------|:-------|:------|
| <service> | valid|missing|config-moved | <description> |

## New Discoveries
- <new component/service/pattern not in docs>

## Recommendations
- <specific update recommendations>
```

### Phase 3: Stub Expansion

Transforms stub files into detailed documentation using specialized scouts.

**Expansion Priority:**

| File | Priority | Scout Type |
|:-----|:---------|:-----------|
| `layers.md` | 1 | Scout-Layers |
| `domain.md` | 2 | Scout-Domain |
| `patterns.md` | 3 | Scout-Patterns |
| `infrastructure.md` | 4 | Scout-Infra |
| `database.md` | 5 | Scout-Database |
| `api.md` | 6 | Scout-API |
| `authentication.md` | 7 | Scout-Auth |

**Conditional Sub-Files:**

| Condition | Create | Scout |
|:----------|:-------|:------|
| Database with >5 tables | `database.md` | Scout-Database |
| REST/GraphQL API | `api.md` | Scout-API |
| Auth system present | `authentication.md` | Scout-Auth |
| Event-driven architecture | `events.md` | Scout-Events |

### Phase 4: Update Main File

After expanding sub-files:

1. Replace inline details with references to sub-files
2. Update sections where drift was detected
3. Preserve human-added content and annotations
4. Regenerate Mermaid diagrams to reflect current architecture
5. Refresh quick reference tables and directive summaries

### Phase 5: Quality Assurance

**Validation Checks:**

| Check | Requirement | Action if Fail |
|:------|:------------|:---------------|
| All sub-file refs resolve | Required | Fix broken references |
| Mermaid diagrams render | Required | Fix syntax errors |
| No orphaned sub-files | Preferred | Remove or link |
| Cross-refs consistent | Required | Update mismatches |
| Code examples valid | Preferred | Update or remove |

---

## Usage Examples

### Expand Stubs (Default)

```bash
/update-arch
```

Expands all stub files to detailed documentation. Use after running `/init-project-fast`.

### Targeted Section Update

```bash
/update-arch layers
/update-arch infrastructure
/update-arch patterns,domain
```

Updates only specified sections, leaving others unchanged.

### Full Refresh

```bash
/update-arch --full
```

Re-analyzes entire codebase and regenerates all sections regardless of state.

### Drift Check Only

```bash
/update-arch --check
```

Reports drift without making changes. Useful for CI/CD pipelines or pre-merge validation.

---

## Integration with PROJECT-ARCH Docs

### File Structure

```
docs/
├── PROJECT-ARCH.md           # Main architecture overview
└── PROJECT-ARCH/
    ├── layers.md             # Detailed layer documentation
    ├── domain.md             # Domain model and bounded contexts
    ├── patterns.md           # Code patterns catalog
    ├── infrastructure.md     # Service and deployment docs
    ├── database.md           # Database schema (if applicable)
    ├── api.md                # API documentation (if applicable)
    └── authentication.md     # Auth flows (if applicable)
```

### Sub-File Templates

**layers.md Structure:**
- Layer overview with Mermaid flowchart
- Per-layer sections with components, contracts, and code examples
- Inbound/outbound interface documentation

**domain.md Structure:**
- Context map with entity relationships
- Per-context entity definitions with attributes
- Value objects, aggregates, and domain events
- Business rules and invariants

**patterns.md Structure:**
- Pattern catalog table
- Per-pattern documentation with rationale
- Implementation examples from actual codebase
- Usage guidance (when to use/avoid)

**infrastructure.md Structure:**
- Service inventory table
- Per-service configuration details
- Connection parameters per environment
- Deployment topology and monitoring

---

## Execution Rules

### Parallel Scout Deployment

All expansion scouts launch in a single parallel batch:
- One Task tool call per scout
- All scouts in the same message
- No inter-scout dependencies
- Each scout writes directly to target sub-file

### Preserve Manual Edits

When updating existing detailed files:
1. Parse file for manual annotations (comments, custom sections)
2. Regenerate structural content
3. Merge preserving manual additions
4. Flag conflicts for human review

### Diagram Requirements

All diagrams use Mermaid syntax:
- `flowchart TB` for layer diagrams
- `flowchart LR` for context maps
- `sequenceDiagram` for flows
- `erDiagram` for database schemas

---

## Best Practices

### When to Run

| Scenario | Command |
|:---------|:--------|
| After `/init-project-fast` | `/update-arch` |
| Major refactoring complete | `/update-arch --full` |
| New service added | `/update-arch infrastructure` |
| Domain model changed | `/update-arch domain` |
| Pre-release validation | `/update-arch --check` |

### Maintaining Quality

1. Run `/update-arch --check` before merging large PRs
2. Review drift reports for unexpected changes
3. Commit documentation updates with related code changes
4. Keep manual annotations in clearly marked sections

### Handling Conflicts

When scouts detect conflicting information:
1. Review generated `conflicts.md` (if present)
2. Manually verify correct state
3. Update source of truth (code or docs)
4. Re-run update

---

## Update Report Format

```markdown
## Update Complete

**Mode**: expand|refresh|targeted
**Duration**: <time>

### Files Updated
- [x] docs/PROJECT-ARCH.md (<N> lines changed)
- [x] docs/PROJECT-ARCH/layers.md (expanded from stub)
- [x] docs/PROJECT-ARCH/domain.md (expanded from stub)
- [ ] docs/PROJECT-ARCH/database.md (created new)

### Drift Corrections
- <component> path updated: `old/path` -> `new/path`
- <service> version updated: `1.2.0` -> `1.3.0`
- <pattern> removed (deprecated)

### New Discoveries
- Added: <new-component> to <layer>
- Added: <new-service> to infrastructure

### Warnings
- <warning about potential issues>

### Manual Review Recommended
- <section> - significant changes detected
```

---

## NPL Dependencies

Required NPL modules:

```bash
npl-load c "syntax,agent,fences,directive,pumps.intent,instructing.alg,formatting.template" --skip {@npl.def.loaded}
npl-load spec "project-arch-spec" --skip {@npl.spec.loaded}
```

**See Also:**
- `npl-load c "fences"` - Fence type reference
- `npl-load c "directive"` - Directive patterns
- `npl-load c "pumps"` - Reasoning pump documentation
- `npl-load c "agent"` - Agent declaration syntax

---

## Related Commands

- `/init-project` - Full project initialization
- `/init-project-fast` - Quick initialization with stubs
- `/update-layout` - Refresh PROJECT-LAYOUT.md
- `@npl-gopher-scout` - Scout agent definition
- `project-arch-spec` - Full specification reference
